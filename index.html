<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tsudanuma AR Rally</title>

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }

        /* ▼▼▼ 追加：リスト開閉ボタン ▼▼▼ */
        #list-toggle-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            line-height: 44px;
            cursor: pointer;
            z-index: 10001; /* リストより手前に */
            user-select: none;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* ▼▼▼ リスト表示（初期は非表示） ▼▼▼ */
        #target-list {
            display: none; /* ← ここで最初は隠す設定にしています */
            position: fixed;
            top: 60px; /* ボタンの下に表示 */
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            font-size: 13px;
            max-width: 180px;
            max-height: 50vh; /* 画面半分以上は覆わない */
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .list-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 4px;
        }
        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .check-mark {
            margin-left: auto;
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
        }

        /* 上部情報パネル */
        #info-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding-top: 20px; 
            background: linear-gradient(rgba(0,0,0,0.8), transparent);
            color: white;
            padding-bottom: 30px;
            z-index: 9999;
            text-align: center;
            text-shadow: 2px 2px 4px black;
            pointer-events: none;
        }
        
        #target-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            margin-right: 5px;
            vertical-align: middle;
            background-color: gray;
        }

        #distance-display {
            font-size: 28px; 
            color: cyan; 
            font-family: monospace; 
            font-weight: bold;
            margin-top: 5px;
        }

        #target-name {
            font-size: 20px;
            font-weight: bold;
        }

        /* 矢印ナビ */
        #guide-ui {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 9998;
        }
        .arrow {
            font-size: 80px;
            color: #ffff00;
            text-shadow: 0 0 10px #ff0000;
            font-weight: 900;
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.2); opacity: 1; } }
    </style>
</head>

<body>
    <div id="list-toggle-btn">≡</div>
    
    <div id="target-list">Loading...</div>

    <div id="info-panel">
        <div style="font-size: 12px; opacity: 0.8;">一番近いターゲット</div>
        <div>
            <span id="target-indicator"></span>
            <span id="target-name">探索中...</span>
        </div>
        <div id="distance-display">--.----m</div>
    </div>

    <div id="guide-ui"></div>

    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-camera gps-camera="minDistance: 0; maxDistance: 5000;" rotation-reader></a-camera>
    </a-scene>

    <script>
        // ==========================================
        // ★ 設定コーナー
        // ==========================================
        
        const VISIBLE_DISTANCE = 50;  // 出現距離
        const HIDE_ARROW_DISTANCE = 10; // 矢印が消える距離
        const ARRIVAL_DISTANCE = 5;   // 到着判定距離

        // ==========================================
        // ★ 座標データ (津田沼周辺)
        // ==========================================
        const targetData = [
            // ▼ここを変更：津田沼駅の座標に変更し、最初から visited: true に設定
            { id: 0, lat: 35.691250, lon: 140.020330, color: '#FF0000', label: '津田沼駅 (Start)', visited: true },
            
            // 以下は以前のランダム座標（津田沼駅の南側エリア）
            { id: 1, lat: 35.690187875511626, lon: 140.02055491951614, color: '#FF8000', label: 'ポイント 2', visited: false },
            { id: 2, lat: 35.68973978570581, lon: 140.02043153582534, color: '#FFFF00', label: 'ポイント 3', visited: false },
            { id: 3, lat: 35.689520801631105, lon: 140.02126335680853, color: '#80FF00', label: 'ポイント 4', visited: false },
            { id: 4, lat: 35.68915200985924, lon: 140.0213174090956, color: '#00FF00', label: 'ポイント 5', visited: false },
            { id: 5, lat: 35.688809269585626, lon: 140.0212346768373, color: '#00FFFF', label: 'ポイント 6', visited: false },
            { id: 6, lat: 35.68894367914206, lon: 140.0207853824227, color: '#0080FF', label: 'ポイント 7', visited: false },
            { id: 7, lat: 35.689070718384734, lon: 140.0202839278186, color: '#8000FF', label: 'ポイント 8', visited: false },
            { id: 8, lat: 35.68951206735917, lon: 140.02169445178453, color: '#FF00FF', label: 'ポイント 9', visited: false }
        ];

        // テクスチャ画像生成
        function createTextTexture(text, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; 
            canvas.height = 128; 
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 10;
            ctx.strokeStyle = color;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'white';
            ctx.font = 'bold 50px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            return canvas.toDataURL();
        }

        // リスト描画
        function renderTargetList() {
            const listContainer = document.getElementById('target-list');
            listContainer.innerHTML = ''; 
            targetData.forEach(data => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const checkMark = data.visited ? '<span class="check-mark">✅</span>' : '';
                const opacity = data.visited ? '0.5' : '1.0';
                item.innerHTML = `
                    <div class="color-dot" style="background-color: ${data.color}; opacity: ${opacity};"></div>
                    <span style="opacity: ${opacity}; color: white;">${data.label}</span>
                    ${checkMark}
                `;
                listContainer.appendChild(item);
            });
        }

        // ▼▼▼ UI制御（ボタンでリストを開閉） ▼▼▼
        const toggleBtn = document.getElementById('list-toggle-btn');
        const listDiv = document.getElementById('target-list');
        
        toggleBtn.addEventListener('click', () => {
            if (listDiv.style.display === 'none') {
                listDiv.style.display = 'block';
                toggleBtn.textContent = '✕'; // 閉じるアイコン
            } else {
                listDiv.style.display = 'none';
                toggleBtn.textContent = '≡'; // メニューアイコン
            }
        });
        // ▲▲▲ UI制御ここまで ▲▲▲

        window.addEventListener('load', () => {
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('a-camera');
            const displayDist = document.getElementById('distance-display');
            const displayName = document.getElementById('target-name');
            const displayIndicator = document.getElementById('target-indicator');
            const guideDiv = document.getElementById('guide-ui');

            let entities = []; 

            renderTargetList();

            // オブジェクト配置
            targetData.forEach((data, index) => {
                const container = document.createElement('a-entity');
                container.setAttribute('gps-entity-place', `latitude: ${data.lat}; longitude: ${data.lon};`);
                container.setAttribute('visible', 'false'); 

                const box = document.createElement('a-box');
                box.setAttribute('scale', '2 2 2');
                box.setAttribute('position', '0 1 0');
                box.setAttribute('material', `color: ${data.color}; opacity: 0.8;`);
                box.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear;');

                const textPlane = document.createElement('a-plane');
                textPlane.setAttribute('position', '0 3.5 0');
                textPlane.setAttribute('scale', '5 1.25 1');
                textPlane.setAttribute('material', 'transparent: true; opacity: 1;');
                textPlane.setAttribute('look-at', '[gps-camera]'); 
                textPlane.setAttribute('src', createTextTexture(data.label, data.color));

                container.appendChild(box);
                container.appendChild(textPlane);
                scene.appendChild(container);

                entities.push({ container: container, data: data });
            });

            setInterval(() => {
                if (!camera) return;

                let minDistance = Infinity;
                let closestItem = null;
                const cameraPos = camera.object3D.position;

                entities.forEach((item) => {
                    const distance = cameraPos.distanceTo(item.container.object3D.position);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestItem = item;
                    }
                });

                if (closestItem) {
                    const distDetail = minDistance.toFixed(4);
                    const currentData = closestItem.data;

                    displayName.textContent = currentData.label; 
                    displayName.style.color = currentData.color === '#FFFF00' ? '#ffff00' : 'white';
                    displayIndicator.style.backgroundColor = currentData.color;

                    if (minDistance > VISIBLE_DISTANCE) {
                        closestItem.container.setAttribute('visible', 'false');
                    } else {
                        closestItem.container.setAttribute('visible', 'true');
                    }

                    if (minDistance < ARRIVAL_DISTANCE) {
                        displayDist.innerHTML = `<span style="color:red; text-shadow:0 0 5px white;">★到着！</span>`;
                        if (!currentData.visited) {
                            currentData.visited = true;
                            renderTargetList(); 
                        }
                    } else {
                        displayDist.innerHTML = `あと ${distDetail}m`;
                    }

                    const targetPos = closestItem.container.object3D.position.clone();
                    camera.object3D.worldToLocal(targetPos);
                    let msg = "";

                    // 近い、または「すでに訪問済み(visited)」なら矢印を出さない
                    if ((minDistance < HIDE_ARROW_DISTANCE && targetPos.z < 0 && Math.abs(targetPos.x) < 2) || currentData.visited) {
                        msg = ""; 
                    } else {
                        if (targetPos.z > 0) {
                            msg = "<div class='arrow'>⬇ 後ろ</div>";
                        } else if (targetPos.x > 0) {
                            msg = "<div class='arrow'>➡ 右</div>";
                        } else {
                            msg = "<div class='arrow'>⬅ 左</div>";
                        }
                    }
                    guideDiv.innerHTML = msg;
                }
            }, 100);
        });
    </script>
</body>
</html>