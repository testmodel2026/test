<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Treasure Hunt AR</title>

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }

        /* 上部の情報パネル */
        #info-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 0;
            z-index: 9999;
            text-align: center;
        }
        
        /* ターゲットの色を表示する丸印 */
        #target-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            margin-right: 5px;
            vertical-align: middle;
        }

        /* 方向指示矢印 */
        #guide-ui {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 9998;
        }
        .arrow {
            font-size: 60px;
            color: #ffff00;
            text-shadow: 2px 2px 4px #000;
            font-weight: 900;
            animation: blink 1s infinite alternate;
        }
        @keyframes blink {
            from { opacity: 0.6; transform: scale(1); }
            to { opacity: 1.0; transform: scale(1.1); }
        }
    </style>
</head>

<body>

    <div id="info-panel">
        <div style="font-size: 14px;">一番近いターゲット:</div>
        <div style="font-size: 24px; font-weight: bold;">
            <span id="target-indicator" style="background-color: gray;"></span>
            <span id="target-name">探索中...</span>
        </div>
        <div id="distance-display" style="font-size: 18px; color: cyan;">GPS取得中...</div>
    </div>

    <div id="guide-ui"></div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
    >
        <a-camera gps-camera="minDistance: 0; maxDistance: 5000;" rotation-reader></a-camera>
    </a-scene>

    <script>
        // ■ 指定された座標と色のリスト
        const targetData = [
            { lat: 35.70178630849327, lon: 139.82401544884175, color: 'red', name: '赤色' },
            { lat: 35.701758175931246, lon: 139.8236600716402, color: 'yellow', name: '黄色' },
            { lat: 35.70174146142711, lon: 139.82337052797118, color: 'blue', name: '青色' },
            { lat: 35.701554486699166, lon: 139.82338933294176, color: 'hotpink', name: 'ピンク' }, // pinkは薄いのでhotpinkに
            { lat: 35.70154550306454, lon: 139.82362449646504, color: '#8B4513', name: '茶色' }
        ];

        window.addEventListener('load', () => {
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('a-camera');
            const displayDist = document.getElementById('distance-display');
            const displayName = document.getElementById('target-name');
            const displayIndicator = document.getElementById('target-indicator');
            const guideDiv = document.getElementById('guide-ui');

            // 箱（エンティティ）を格納する配列
            let boxes = [];

            // 1. リストの座標に箱を生成して配置
            targetData.forEach((data) => {
                const box = document.createElement('a-box');
                box.setAttribute('scale', '2 2 2'); // 2mサイズで見やすく
                box.setAttribute('material', `color: ${data.color}; opacity: 0.9;`);
                box.setAttribute('gps-entity-place', `latitude: ${data.lat}; longitude: ${data.lon};`);
                box.setAttribute('look-at', '[gps-camera]'); // 常にこちらを向く
                
                // 独自プロパティとしてデータを保持させておく
                box.dataset.name = data.name;
                box.dataset.color = data.color;

                scene.appendChild(box);
                boxes.push(box);
            });

            // 2. 常時監視ループ（0.2秒ごとに実行）
            setInterval(() => {
                if (!camera) return;

                let minDistance = Infinity;
                let closestBox = null;

                const cameraPos = camera.object3D.position;

                // 全部の箱との距離を計算して、一番近いものを探す
                boxes.forEach((box) => {
                    const boxPos = box.object3D.position;
                    
                    // A-Frame上の3D距離を計算 (GPS座標変換後の位置)
                    const distance = cameraPos.distanceTo(boxPos);

                    if (distance < minDistance) {
                        minDistance = distance;
                        closestBox = box;
                    }
                });

                // 一番近い箱が見つかったら情報を更新
                if (closestBox) {
                    const distInt = Math.round(minDistance);
                    
                    // 画面表示更新
                    displayName.textContent = closestBox.dataset.name;
                    displayName.style.color = closestBox.dataset.color === 'yellow' ? '#ffff00' : 'white';
                    displayIndicator.style.backgroundColor = closestBox.dataset.color;
                    
                    if (distInt < 5) {
                        displayDist.innerHTML = `<span style="color:red; font-size:24px;">★ここです！</span> (${distInt}m)`;
                    } else {
                        displayDist.innerHTML = `あと ${distInt}m`;
                    }

                    // 矢印ナビゲーションの計算
                    // 選ばれた「一番近い箱」に対して方向を計算する
                    const targetPos = closestBox.object3D.position.clone();
                    camera.object3D.worldToLocal(targetPos);

                    let msg = "";
                    // 距離がある程度離れていて(2m以上)、視界に入っていない場合に矢印を出す
                    if (targetPos.z < 0 && Math.abs(targetPos.x) < 3 && distInt < 100) {
                        msg = ""; // 目の前にある
                    } else {
                        if (targetPos.z > 0) {
                            msg = "<div class='arrow'>⬇ 後ろ！</div>";
                        } else if (targetPos.x > 0) {
                            msg = "<div class='arrow'>➡ 右</div>";
                        } else {
                            msg = "<div class='arrow'>⬅ 左</div>";
                        }
                    }
                    guideDiv.innerHTML = msg;
                }

            }, 200);
        });
    </script>
</body>
</html>