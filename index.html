<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Spawn at Location (Fixed)</title>

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        #info-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: sans-serif;
            font-weight: bold;
            padding: 10px;
            z-index: 9999;
            text-align: center;
        }
        #spawn-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            padding: 15px;
            background-color: #ff0055;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            z-index: 9999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #spawn-btn:active {
            background-color: #cc0044;
            transform: translateX(-50%) translateY(2px);
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="info-panel">
        <span id="distance-display" style="font-size: 20px; color: cyan;">GPS取得中...</span><br>
        <span style="font-size: 12px; color: #ccc;">ボタンを押すと足元に箱が出ます</span>
    </div>

    <button id="spawn-btn">ここに箱を置く！</button>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true;"
    >
        <a-box
            id="target-box"
            material="color: red; side: double;"
            scale="0.5 0.5 0.5"
            position="0 0 0"
            visible="false"
        ></a-box>

        <a-camera gps-camera="minDistance: 0; maxDistance: 5000;" rotation-reader></a-camera>
    </a-scene>

    <script>
        window.addEventListener('load', () => {
            const display = document.getElementById('distance-display');
            const box = document.getElementById('target-box');
            const btn = document.getElementById('spawn-btn');

            btn.addEventListener('click', () => {
                btn.textContent = "座標取得中...";
                
                // highAccuracy: true を追加して精度を上げる
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // 1. 座標をセット
                    box.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
                    
                    // 2. Y軸(高さ)をカメラの少し下に調整したい場合、position属性で調整可能
                    // AR.jsの仕様上、gps-entity-placeがつくとpositionはオフセットとして扱われます
                    box.setAttribute('position', '0 0 0'); 
                    
                    // 3. 表示をオンにする
                    box.setAttribute('visible', 'true');

                    btn.textContent = "設置完了！";
                    btn.style.backgroundColor = "blue";
                    
                    alert(`設置しました！\n緯度:${lat.toFixed(5)}\n経度:${lon.toFixed(5)}\n\n※見えない場合は周囲を見回すか、数歩下がってください。`);
                }, (err) => {
                    console.error(err);
                    alert("位置情報が取れませんでした");
                }, {
                    enableHighAccuracy: true, // 高精度モード
                    timeout: 5000,
                    maximumAge: 0
                });
            });

            box.addEventListener('gps-entity-place-update-position', (event) => {
                const distInt = Math.round(event.detail.distance);
                display.innerHTML = `あと ${distInt}m`;
                
                // 距離が近すぎる(5m以内)ときは赤文字
                if(distInt < 5) {
                    display.style.color = "red";
                    display.innerHTML = `あと ${distInt}m <br>★足元にあります`;
                } else {
                    display.style.color = "cyan";
                }
            });
        });
    </script>
</body>
</html>